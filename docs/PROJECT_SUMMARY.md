
# Dynamic‑Power‑Daemon — Comprehensive Project Summary  
*Snapshot: 2025‑07‑23 (post v4.1.0, pkgrel 3)*  

---

## 1. Purpose

Dynamic‑Power‑Daemon (DPD) is a smart power‑profile manager for Linux laptops/desktops.  
It adjusts `powerprofilesctl` / `asusctl` modes based on **CPU load, power source,
user overrides, and running processes**, while exposing a DBus API and a Qt tray UI.

## Comment Preservation

Inline comments added by the maintainer during code reviews are **canonical documentation**.  
**Do not remove them.** If a comment becomes outdated, update it so the original intent remains clear.
---

## 2. Current Repository Layout

```
dynamic-power-daemon/
├─ Makefile                     # root build/install script (site‑packages aware)
├─ PKGBUILD                     # Arch AUR package (pkgrel 3)
├─ dynamic-power-daemon.install # .install script (enables units on install)
├─ dynamic-power.service        # root daemon unit
├─ python/
│  ├─ dynamic_power/            # Python package
│  │   ├─ __init__.py
│  │   ├─ cli.py                # entry point for root daemon
│  │   ├─ dynamic_power_user.py
│  │   ├─ dynamic_power_command.py
│  │   ├─ dynamic_power_session_helper.py
│  │   └─ … other helpers
│  ├─ resources/
│  │   ├─ dbus/org.dynamic_power.Daemon.conf
│  │   └─ systemd-user/
│  │       ├─ dynamic_power_session.service
│  │       ├─ dynamic_power_command.service
│  │       └─ 90-dynamic-power.preset
│  └─ share/dynamic-power/*.yaml  # default configs
└─ DEVELOPMENT_OVERVIEW.md     # high‑level roadmap (generated earlier)
```

---

## 3. Installed System Components

| Path | Role |
|------|------|
| `/usr/bin/dynamic_power` | **Root daemon** (system unit) |
| `/usr/bin/dynamic_power_session_helper` | Wrapper that starts *dynamic_power_user* |
| `/usr/bin/dynamic_power_user` | Process matcher & override sender |
| `/usr/bin/dynamic_power_command` | Qt 6 tray UI |
| `/etc/dbus-1/system.d/org.dynamic_power.Daemon.conf` | DBus policy |
| `/usr/lib/systemd/system/dynamic_power.service` | Root daemon unit *(enabled, started)* |
| `/usr/lib/systemd/user/dynamic_power_session.service` | User helper unit *(preset Enabled)* |
| `/usr/lib/systemd/user/dynamic_power_command.service` | Tray UI unit *(after `graphical-session.target`)* |

---

## 4. Dependencies (Arch)

```
python, python-yaml, python-dbus, python-dbus-next, python-gobject,
python-psutil, python-setproctitle, python-systemd,
python-inotify-simple (AUR), python-pyqt6, python-pyqtgraph,
xcb-util-cursor       # Qt 6 X11 backend
Optional: powerprofilesctl, asusctl, xorg-xrandr, kscreen
```

---

## 5. Design Highlights

| Area | Decision |
|------|----------|
| **Install path** | Python package into *site‑packages*, executables in `/usr/bin`. |
| **IPC** | DBus service `org.dynamic_power.Daemon` (system bus). |
| **Config** | YAML: `/etc/dynamic_power.yaml` plus `~/.config/dynamic_power/config.yaml`. |
| **Runtime state** | `/run/dynamic_power_state.yaml` and `/run/user/$UID/dynamic_power_control.yaml` *(to be replaced by DBus signals in Phase 7)* |
| **Systemd strategy** | Root daemon auto‑enabled; user units preset & start post‑login. |
| **Panel Over‑drive** | Implemented in *dynamic_power_session_helper* via `set_panel_overdrive()` (DBus to `asusctl`, CLI fallback). Enabled/disabled on AC/BAT based on `panel.overdrive.*` config keys. |

---

## 6. Roadmap (Condensed)

| Phase | Feature | Status |
|-------|---------|--------|
| 3 | **Panel Over‑drive toggle** | *In progress* — code added, needs live test |
| 4 | Refresh‑rate auto‑switch | pending |
| 5 | KDE panel auto‑hide | pending |
| 6 | Merge **user** & **session helper** | pending |
| 7 | Replace YAML state with DBus signals | pending |
| 8 | dGPU notifier | backlog |
| 9 | UI polish / badges | backlog |
| 10 | CI + tests | backlog |

---

## 7. Known Issues / Next Investigations

1. **DBus ServiceUnknown** errors appear if `dynamic_power.service` is not running.
   *Fix*: `.install` script now enables `dynamic_power.service`.

2. **Panel over‑drive** may fail on systems without `asusctl` DBus interface.
   *Fallback* to CLI has been added; still requires testing.

3. **YAML state files** race conditions; will be removed in Phase 7.

---

## 8. Packaging Notes

* Root Makefile must be invoked with `DESTDIR` in PKGBUILD.
* `.install` script now uses `systemctl enable --now dynamic_power.service` to start daemon immediately.
* `pkgrel` bumped each time service integration or dependency list changes.

---

## 9. Quick Commands

```bash
# check root daemon
sudo systemctl status dynamic_power.service

# live logs
sudo journalctl -fu dynamic_power.service
journalctl --user -fu dynamic_power_session.service
```

---

*Generated by ChatGPT‑o3 (2025‑07‑23) for continuity across sessions.*


### 9. Runtime Data vs. Configuration

* **Configuration** is stored in YAML files and read on startup (`config.py` auto‑upgrades the schema).
* **Runtime sensor data** (power source, load, battery %, etc.) **MUST travel over DBus (`GetMetrics`) – not via YAML scratch files.**
  This eliminates latency and file‑polling hacks introduced in early Bash versions.


### Runtime features

* **Battery detection → Session helper DBus:** The session helper now owns all
  power‑source & battery‑percent sensing and publishes them via
  `GetMetrics()`. The tray consumes these over DBus—no YAML hacks.
* **Panel overdrive auto‑toggle (2025‑07‑23):** Session helper toggles the
  display’s overdrive using `asusctl` when AC ↔ battery changes, respecting
  `panel.overdrive.enable_on_ac` and hardware support detection.


#### Latest progress (2025‑07‑23)

| Feature | Status |
|---------|--------|
| Panel over‑drive toggle | **Completed** |
| Desktop entry & icon | **Completed** |
| Systemd‑user replacement | **Completed** (Autostart via .desktop) |

